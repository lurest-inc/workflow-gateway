name: Lurest Gateway Dispatch (to private-workflows)

on:
  workflow_call:
    inputs:
      target:
        description: "Ëµ∑Âãï„Åô„Çã workflow(test-a / test-b)"
        required: false
        default: "test-a"
        type: string
      message:
        description: "private-workflows ÂÅ¥„Å∏Ê∏°„Åô„É°„ÉÉ„Çª„Éº„Ç∏"
        required: false
        default: "Dispatched via workflow-gateway"
        type: string
    secrets:
      LUREST_DISPATCH_TOKEN:
        description: "fine-grained PAT(private-workflows „Å´ÂØæ„Åó„Å¶ Actions: write „ÅåÂøÖË¶Å)"
        required: true

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve workflow file
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          case "${{ inputs.target }}" in
            test-a) echo "workflow_file=test-a.yml" >> "$GITHUB_OUTPUT" ;;
            test-b) echo "workflow_file=test-b.yml" >> "$GITHUB_OUTPUT" ;;
            *)
              echo "‚ùå invalid target: ${{ inputs.target }}"
              echo "allowed targets: test-a, test-b"
              exit 1
              ;;
          esac

      - name: Dispatch private workflow
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.LUREST_DISPATCH_TOKEN }}
          TARGET_REPO: lurest-inc/private-workflows
          WORKFLOW_FILE: ${{ steps.resolve.outputs.workflow_file }}
          TARGET_REF: main
          CALLER_REPO: ${{ github.repository }}
          MESSAGE: ${{ inputs.message }}
        run: |
          set -euo pipefail

          payload=$(python - <<'PY'
import json, os
print(json.dumps({
  "ref": os.environ["TARGET_REF"],
  "inputs": {
    "caller_repo": os.environ["CALLER_REPO"],
    "message": os.environ["MESSAGE"]
  }
}))
PY
)

          echo "üöÄ Dispatching ${TARGET_REPO}/${WORKFLOW_FILE} @ ${TARGET_REF}"
          code=$(curl -L -sS -o /dev/null -w "%{http_code}" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${TARGET_REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches" \
            -d "${payload}")

          if [[ "$code" != "204" ]]; then
            echo "‚ùå Dispatch failed. HTTP ${code}"
            exit 1
          fi

          echo "‚úÖ Dispatch accepted (HTTP 204)."

      - name: Summary
        run: |
          echo "## ‚úÖ Dispatch accepted" >> $GITHUB_STEP_SUMMARY
          echo "- target: \`${{ inputs.target }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- workflow: \`${{ steps.resolve.outputs.workflow_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ref: \`main\`" >> $GITHUB_STEP_SUMMARY
