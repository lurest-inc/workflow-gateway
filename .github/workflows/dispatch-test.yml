name: Lurest Gateway Dispatch (to private-workflows)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "èµ·å‹•ã™ã‚‹ workflow(test-a / test-b)"
        required: false
        default: "test-a"
        type: string
      message:
        description: "private-workflows å´ã¸æ¸¡ã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
        required: false
        default: "Dispatched via workflow-gateway"
        type: string
      LUREST_DISPATCH_TOKEN:
        description: "fine-grained PAT(private-workflows ã«å¯¾ã—ã¦ Actions: write ãŒå¿…è¦)"
        required: true
        type: string  
  workflow_call:
    inputs:
      target:
        description: "èµ·å‹•ã™ã‚‹ workflow(test-a / test-b)"
        required: false
        default: "test-a"
        type: string
      message:
        description: "private-workflows å´ã¸æ¸¡ã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
        required: false
        default: "Dispatched via workflow-gateway"
        type: string
      LUREST_DISPATCH_TOKEN:
        description: "fine-grained PAT(private-workflows ã«å¯¾ã—ã¦ Actions: write ãŒå¿…è¦)"
        required: true
        type: string

jobs:
  dispatch:
    runs-on: ubuntu-latest
    env:
      ALLOWED_TARGETS: |
        {
          "test-a": "Test workflow for target A",
          "test-b": "Test workflow for target B"
        }
    steps:
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          TARGET="${{ inputs.target }}"
          ALLOWLIST=($(echo "$ALLOWED_TARGETS" | jq -r 'keys[]'))

          allowed=false
          for target in "${ALLOWLIST[@]}"; do
            if [[ "$TARGET" == "$target" ]]; then allowed=true; fi
          done

          if [[ "$allowed" != "true" ]]; then
            echo "âŒ Invalid target: $TARGET"
            echo "Allowed targets: ${ALLOWLIST[*]}"
            exit 1
          fi

      - name: Resolve workflow file
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          case "${{ inputs.target }}" in
            test-a) echo "workflow_file=test-a.yml" >> "$GITHUB_OUTPUT" ;;
            test-b) echo "workflow_file=test-b.yml" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Mask sensitive token
        run: echo "::add-mask::${{ inputs.LUREST_DISPATCH_TOKEN }}"

      - name: Debug token generation
        shell: bash
        run: |
          set -euo pipefail
          
          echo "=== Token Generation Debug ==="
          echo "APP_ID: ${{ vars.APP_ID }}"
          echo "PRIVATE_KEY exists: $([ -z '${{ secrets.PRIVATE_KEY }}' ] && echo 'NO' || echo 'YES')"
          echo "PRIVATE_KEY length: ${#PRIVATE_KEY}"
          echo "Generated token exists: $([ -z '${{ inputs.LUREST_DISPATCH_TOKEN }}' ] && echo 'NO' || echo 'YES')"
          echo "Generated token length: $(echo -n '${{ inputs.LUREST_DISPATCH_TOKEN }}' | wc -c)"
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}

      - name: Validate received token with gh command
        shell: bash
        env:
          GH_TOKEN: ${{ inputs.LUREST_DISPATCH_TOKEN }}
        run: |
          set -euo pipefail
      
          echo "=== Validating token received in dispatch-test ==="
          
          echo "Test 1: Get authenticated user"
          gh api user --jq '.login' || echo "âŒ Failed"
          
          echo ""
          echo "Test 2: Access private-workflows"
          gh api repos/lurest-inc/private-workflows --jq '.name' || echo "âŒ Failed"
          
          echo ""
          echo "Test 3: List workflows"
          gh api repos/lurest-inc/private-workflows/actions/workflows --jq '.workflows[].name' || echo "âŒ Failed"

          
      - name: Validate token across repositories
        shell: bash
        env:
          GH_TOKEN: ${{ inputs.LUREST_DISPATCH_TOKEN }}
        run: |
          set -euo pipefail

          echo "=== Token Validation Test ==="

          # Test 1: Check access to workflow-gateway
          echo ""
          echo "ðŸ“‹ Test 1: Access to workflow-gateway"
          gh api repos/lurest-inc/workflow-gateway --jq '.name' || echo "âŒ Failed to access workflow-gateway"

          # Test 2: Check access to private-workflows
          echo ""
          echo "ðŸ“‹ Test 2: Access to private-workflows"
          gh api repos/lurest-inc/private-workflows --jq '.name' || echo "âŒ Failed to access private-workflows"

          # Test 3: Check if we can list workflows in private-workflows
          echo ""
          echo "ðŸ“‹ Test 3: List workflows in private-workflows"
          gh api repos/lurest-inc/private-workflows/actions/workflows --jq '.workflows[].name' || echo "âŒ Failed to list workflows"

          echo ""
          echo "âœ… Token validation complete"
    
      - name: Dispatch private workflow
        shell: bash
        env:
          GH_TOKEN: ${{ inputs.LUREST_DISPATCH_TOKEN }}
          TARGET_REPO: lurest-inc/private-workflows
          WORKFLOW_FILE: ${{ steps.resolve.outputs.workflow_file }}
          TARGET_REF: main
          CALLER_REPO: ${{ github.repository }}
          MESSAGE: ${{ inputs.message }}
        run: |
          set -euo pipefail
        
          echo "=== Dispatch to private-workflows ==="
          echo "GH_TOKEN length: ${#GH_TOKEN}"
          echo "CALLER_REPO: ${CALLER_REPO}"
          echo "TARGET_REPO: ${TARGET_REPO}"
          echo "WORKFLOW_FILE: ${WORKFLOW_FILE}"
        
          echo "ðŸš€ Dispatching ${TARGET_REPO}/${WORKFLOW_FILE} @ ${TARGET_REF}"
          
          gh workflow run "${WORKFLOW_FILE}" \
            --repo "${TARGET_REPO}" \
            --ref "${TARGET_REF}" \
            --field "caller_repo=${CALLER_REPO}" \
            --field "message=${MESSAGE}" \
            --field "LUREST_DISPATCH_TOKEN=${GH_TOKEN}"
        
          echo "âœ… Dispatch accepted."


      - name: Summary
        run: |
          echo "## âœ… Dispatch accepted" >> $GITHUB_STEP_SUMMARY
          echo "- target: \`${{ inputs.target }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- workflow: \`${{ steps.resolve.outputs.workflow_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ref: \`main\`" >> $GITHUB_STEP_SUMMARY
