name: Lurest Gateway Dispatch (to private-workflows)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "èµ·å‹•ã™ã‚‹ workflow(test-a / test-b)"
        required: false
        default: "test-a"
        type: string
      message:
        description: "private-workflows å´ã¸æ¸¡ã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
        required: false
        default: "Dispatched via workflow-gateway"
        type: string
      LUREST_DISPATCH_TOKEN:
        description: "fine-grained PAT(private-workflows ã«å¯¾ã—ã¦ Actions: write ãŒå¿…è¦)"
        required: true
        type: string

jobs:
  dispatch:
    runs-on: ubuntu-latest
    env:
      ALLOWED_TARGETS: |
        {
          "test-a": "Test workflow for target A",
          "test-b": "Test workflow for target B"
        }
    steps:
      - uses: actions/create-github-app-token@v2.2.1
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: lurest-inc
          repositories: |
            private-workflows

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          TARGET="${{ inputs.target }}"
          ALLOWLIST=($(echo "$ALLOWED_TARGETS" | jq -r 'keys[]'))

          allowed=false
          for target in "${ALLOWLIST[@]}"; do
            if [[ "$TARGET" == "$target" ]]; then allowed=true; fi
          done

          if [[ "$allowed" != "true" ]]; then
            echo "âŒ Invalid target: $TARGET"
            echo "Allowed targets: ${ALLOWLIST[*]}"
            exit 1
          fi

      - name: Resolve workflow file
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          case "${{ inputs.target }}" in
            test-a) echo "workflow_file=test-a.yml" >> "$GITHUB_OUTPUT" ;;
            test-b) echo "workflow_file=test-b.yml" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Dispatch private workflow
        shell: bash
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          TARGET_REPO: lurest-inc/private-workflows
          WORKFLOW_FILE: ${{ steps.resolve.outputs.workflow_file }}
          TARGET_REF: v0.0.4
          CALLER_REPO: ${{ github.repository }}
          MESSAGE: ${{ inputs.message }}
        run: |
          set -euo pipefail

          echo "=== Dispatch to private-workflows ==="

          echo "ðŸš€ Dispatching ${TARGET_REPO}/${WORKFLOW_FILE} @ ${TARGET_REF}"

          gh workflow run "${WORKFLOW_FILE}" \
            --repo "${TARGET_REPO}" \
            --ref "${TARGET_REF}" \
            --field "caller_repo=${CALLER_REPO}" \
            --field "message=${MESSAGE}" \
            --field "LUREST_DISPATCH_TOKEN=${{ inputs.LUREST_DISPATCH_TOKEN }}"

          echo "âœ… Dispatch accepted."

      - name: Summary
        run: |
          echo "## âœ… Dispatch accepted" >> $GITHUB_STEP_SUMMARY
          echo "- target: \`${{ inputs.target }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- workflow: \`${{ steps.resolve.outputs.workflow_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ref: \`main\`" >> $GITHUB_STEP_SUMMARY
