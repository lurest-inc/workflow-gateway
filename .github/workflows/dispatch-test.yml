name: Lurest Gateway Dispatch (to private-workflows)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "èµ·å‹•ã™ã‚‹ workflow(test-a / test-b)"
        required: false
        default: "test-a"
        type: string
      message:
        description: "private-workflows å´ã¸æ¸¡ã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
        required: false
        default: "Dispatched via workflow-gateway"
        type: string
      LUREST_DISPATCH_TOKEN:
        description: "fine-grained PAT(private-workflows ã«å¯¾ã—ã¦ Actions: write ãŒå¿…è¦)"
        required: true
        type: string  
  workflow_call:
    inputs:
      target:
        description: "èµ·å‹•ã™ã‚‹ workflow(test-a / test-b)"
        required: false
        default: "test-a"
        type: string
      message:
        description: "private-workflows å´ã¸æ¸¡ã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"
        required: false
        default: "Dispatched via workflow-gateway"
        type: string
      LUREST_DISPATCH_TOKEN:
        description: "fine-grained PAT(private-workflows ã«å¯¾ã—ã¦ Actions: write ãŒå¿…è¦)"
        required: true
        type: string

jobs:
  dispatch:
    runs-on: ubuntu-latest
    env:
      ALLOWED_TARGETS: |
        {
          "test-a": "Test workflow for target A",
          "test-b": "Test workflow for target B"
        }
    steps:
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          TARGET="${{ inputs.target }}"
          ALLOWLIST=($(echo "$ALLOWED_TARGETS" | jq -r 'keys[]'))

          allowed=false
          for target in "${ALLOWLIST[@]}"; do
            if [[ "$TARGET" == "$target" ]]; then allowed=true; fi
          done

          if [[ "$allowed" != "true" ]]; then
            echo "âŒ Invalid target: $TARGET"
            echo "Allowed targets: ${ALLOWLIST[*]}"
            exit 1
          fi

      - name: Resolve workflow file
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          case "${{ inputs.target }}" in
            test-a) echo "workflow_file=test-a.yml" >> "$GITHUB_OUTPUT" ;;
            test-b) echo "workflow_file=test-b.yml" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Mask sensitive token
        run: echo "::add-mask::${{ inputs.LUREST_DISPATCH_TOKEN }}"
        
      - name: Debug token
        run: |
          echo "Token is set: $([ -z '${{ inputs.LUREST_DISPATCH_TOKEN }}' ] && echo 'NO' || echo 'YES')"
          echo "Token length: ${#{{ inputs.LUREST_DISPATCH_TOKEN }}}"  # â† inputs ã‹ã‚‰ç›´æŽ¥å–å¾—
    
      - name: Dispatch private workflow
        shell: bash
        env:
          GH_TOKEN: ${{ inputs.LUREST_DISPATCH_TOKEN }}
          TARGET_REPO: lurest-inc/private-workflows
          WORKFLOW_FILE: ${{ steps.resolve.outputs.workflow_file }}
          TARGET_REF: main
          CALLER_REPO: ${{ github.repository }}
          MESSAGE: ${{ inputs.message }}
        run: |
          set -euo pipefail

          echo "Debug: GH_TOKEN length: ${#GH_TOKEN}"
          echo "Debug: inputs.LUREST_DISPATCH_TOKEN: ${{ inputs.LUREST_DISPATCH_TOKEN }}"

          echo "ðŸš€ Dispatching ${TARGET_REPO}/${WORKFLOW_FILE} @ ${TARGET_REF}"
          
          gh workflow run "${WORKFLOW_FILE}" \
            --repo "${TARGET_REPO}" \
            --ref "${TARGET_REF}" \
            --field "caller_repo=${CALLER_REPO}" \
            --field "message=${MESSAGE}"

          echo "âœ… Dispatch accepted."

      - name: Summary
        run: |
          echo "## âœ… Dispatch accepted" >> $GITHUB_STEP_SUMMARY
          echo "- target: \`${{ inputs.target }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- workflow: \`${{ steps.resolve.outputs.workflow_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ref: \`main\`" >> $GITHUB_STEP_SUMMARY
