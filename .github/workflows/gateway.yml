name: Lurest Workflow Gateway

on:
  workflow_call:
    inputs:
      workflow_file:
        description: "private-workflows å´ã® workflow ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹: core.ymlï¼‰"
        required: false
        default: "core.yml"
        type: string
      ref:
        description: "private-workflows å´ã®èµ·å‹•å¯¾è±¡ refï¼ˆä¾‹: mainï¼‰"
        required: false
        default: "main"
        type: string
      inputs_json:
        description: 'workflow_dispatch ã® inputs ã‚’ JSON æ–‡å­—åˆ—ã§æ¸¡ã™ï¼ˆä¾‹: {"foo":"bar"}ï¼‰'
        required: false
        default: "{}"
        type: string
    secrets:
      LUREST_DISPATCH_TOKEN:
        description: "Lurest ãŒç™ºè¡Œã—ãŸ fine-grained PATï¼ˆprivate-workflows ã«å¯¾ã™ã‚‹ Actions: write ãŒå¿…è¦ï¼‰"
        required: true

jobs:
  dispatch:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail

          WORKFLOW_FILE="${{ inputs.workflow_file }}"

          # ã–ã£ãã‚Šå±é™ºãªæŒ‡å®šã‚’å¼¾ãï¼ˆãƒ‘ã‚¹ã£ã½ã„æŒ‡å®šã‚„å¤‰ãªæ–‡å­—ï¼‰
          if [[ ! "$WORKFLOW_FILE" =~ ^[A-Za-z0-9_.-]+\.ya?ml$ ]]; then
            echo "âŒ Invalid workflow_file: $WORKFLOW_FILE"
            exit 1
          fi

          # âœ… ã“ã“ã¯ã€Œè¨±å¯ãƒªã‚¹ãƒˆã€é‹ç”¨ã«ã™ã‚‹ã®ãŒå®‰å…¨ã§ã™ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¢—ã‚„ã™ï¼‰
          ALLOWLIST=("core.yml")
          allowed=false
          for f in "${ALLOWLIST[@]}"; do
            if [[ "$WORKFLOW_FILE" == "$f" ]]; then allowed=true; fi
          done

          if [[ "$allowed" != "true" ]]; then
            echo "âŒ workflow_file is not allowed: $WORKFLOW_FILE"
            echo "Allowed: ${ALLOWLIST[*]}"
            exit 1
          fi

      - name: Dispatch private workflow (workflow_dispatch)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.LUREST_DISPATCH_TOKEN }}
          TARGET_REPO: lurest-inc/private-workflows
          WORKFLOW_FILE: ${{ inputs.workflow_file }}
          TARGET_REF: ${{ inputs.ref }}
          INPUTS_JSON: ${{ inputs.inputs_json }}
        run: |
          set -euo pipefail

          # inputs_json ãŒå£Šã‚Œã¦ã„ãŸã‚‰æ­¢ã‚ã‚‹
          echo "$INPUTS_JSON" | python -c 'import json,sys; json.load(sys.stdin)'

          echo "ğŸš€ Dispatching ${TARGET_REPO} / ${WORKFLOW_FILE} @ ${TARGET_REF}"

          # JSON inputs ã‹ã‚‰å€‹åˆ¥ã® --field å¼•æ•°ã‚’ç”Ÿæˆ
          declare -a fields
          while IFS= read -r key; do
            value=$(echo "$INPUTS_JSON" | jq -r ".\"$key\"")
            fields+=("--field" "$key=$value")
          done < <(echo "$INPUTS_JSON" | jq -r 'keys[]')

          # gh CLI ã§ workflow_dispatch ã‚’å®Ÿè¡Œ
          gh workflow run "${WORKFLOW_FILE}" \
            --repo "${TARGET_REPO}" \
            --ref "${TARGET_REF}" \
            "${fields[@]}"

          echo "âœ… Dispatch accepted."

      - name: Summary
        run: |
          echo "### âœ… Lurest Workflow Gateway" >> $GITHUB_STEP_SUMMARY
          echo "- Dispatched: lurest-inc/private-workflows" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: \`${{ inputs.workflow_file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Ref: \`${{ inputs.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Note: dispatch ã¯éåŒæœŸã§ã™ï¼ˆprivate å´ã®å®Œäº†å¾…ã¡ã¯ã—ã¾ã›ã‚“ï¼‰" >> $GITHUB_STEP_SUMMARY
