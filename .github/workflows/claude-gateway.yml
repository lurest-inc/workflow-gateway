name: Claude Gateway

on:
  workflow_call:
    secrets:
      owner_token:
        description: "GitHub Token for accessing repository"
        required: true
      LUREST_DISPATCH_TOKEN:
        description: "PAT for accessing lurest-inc/private-workflows"
        required: true

jobs:
  gatewayGuard:
    runs-on: ubuntu-latest
    steps:
      - name: Verify access to private-workflows
        id: verify
        run: |
          set -euo pipefail
          TOKEN="${TOKEN:?TOKEN missing}"
          REF="${PRIVATE_WORKFLOWS_REF}"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/lurest-inc/private-workflows/git/ref/tags/${REF}")

          [ "$HTTP_STATUS" = "200" ] || (echo "::error::Token verification failed" && exit 1)
        env:
          PRIVATE_WORKFLOWS_REF: v0.0.13
          TOKEN: ${{ secrets.LUREST_DISPATCH_TOKEN }}

  gateway:
    needs: gatewayGuard
    uses: lurest-inc/private-workflows/.github/workflows/cc-gateway-receiver.yml@v0.0.13
    with:
      event_name: ${{ github.event_name }}
      action: ${{ github.event.action || '' }}
      repository: ${{ github.repository }}
      label_name: ${{ github.event.label.name || '' }}
      comment_body: ${{ github.event.comment.body || '' }}
      author_association: ${{ github.event.comment.author_association || '' }}
      issue_number: ${{ github.event.issue.number || '' }}
      pr_number: ${{ github.event.pull_request.number || '' }}
      sender_login: ${{ github.event.sender.login || '' }}
    secrets:
      owner_token: ${{ secrets.owner_token }}
      dispatch_token: ${{ secrets.LUREST_DISPATCH_TOKEN }}
